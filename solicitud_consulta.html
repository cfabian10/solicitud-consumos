<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitud de Consumos</title>
    <!-- Tailwind CSS (CDN for standalone usage) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background: #f1f5f9;
        }

        .glass-panel {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        h1,
        h2,
        h3 {
            color: #003A70;
        }

        .primary-btn {
            background-color: #0056A4;
            color: white;
            transition: all 0.2s;
        }

        .primary-btn:hover {
            background-color: #003A70;
        }
    </style>
    <!-- SheetJS for Excel reading -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
</head>

<body class="min-h-screen flex items-center justify-center p-6 text-slate-800">
    <div class="w-full max-w-5xl space-y-6">
        <div class="glass-panel w-full p-8">
            <div class="flex items-center justify-between mb-8 pb-4 border-b border-gray-200">
                <div>
                    <h1 class="text-3xl font-black">Solicitud de Consumos</h1>
                    <p class="text-slate-500 mt-1">Consulta detallada de información por Unidad de Negocio (UES).</p>
                </div>
                <i class="fa-solid fa-database text-4xl text-blue-200"></i>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- SECCIÓN 1: PARÁMETROS -->
            <div>
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span
                        class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                    Configuración de Filtros
                </h3>

                <div class="space-y-4">
                    <!-- SOLICITANTE -->
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Solicitante (Tu
                            Nombre)</label>
                        <input type="text" id="solicitante-name"
                            class="w-full p-2 bg-white border border-gray-300 rounded focus:border-blue-500 focus:outline-none uppercase"
                            placeholder="EJ: JUAN.PEREZ">
                    </div>

                    <!-- TIPO -->
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Tipo de Entidad</label>
                        <div class="flex gap-4">
                            <label
                                class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded border border-gray-200 shadow-sm hover:border-blue-500">
                                <input type="radio" name="extract-type" value="persona" checked>
                                <i class="fa-solid fa-user text-gray-400"></i> Personas
                            </label>
                            <label
                                class="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded border border-gray-200 shadow-sm hover:border-blue-500">
                                <input type="radio" name="extract-type" value="empresa">
                                <i class="fa-solid fa-building text-gray-400"></i> Empresas
                            </label>
                        </div>
                    </div>

                    <!-- UES -->
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Unidad de Negocio
                            (UES)</label>
                        <select id="special-ues"
                            class="w-full p-2 bg-white border border-gray-300 rounded focus:border-blue-500 focus:outline-none">
                            <option value="TODAS">TODAS (Vivienda, RyD, Hoteles, etc.)</option>
                            <option value="VIVIENDA">VIVIENDA</option>
                            <option value="RYD">RECREACIÓN Y DEP. (RYD)</option>
                            <option value="HOTELES">HOTELES</option>
                            <option value="PISCILAGO">PISCILAGO</option>
                            <option value="MEDICAMENTOS">MEDICAMENTOS</option>
                        </select>
                    </div>

                    <!-- RANGO FECHAS -->
                    <div class="bg-slate-50 p-4 rounded-lg">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Rango de Fechas</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="text-xs text-gray-500 block mb-1">Desde</span>
                                <div class="flex gap-1">
                                    <select id="special-year-start" class="w-1/2 p-1 border rounded">
                                        <option value="2023">2023</option>
                                        <option value="2024" selected>2024</option>
                                        <option value="2025">2025</option>
                                    </select>
                                    <select id="special-month-start" class="w-1/2 p-1 border rounded">
                                        <option value="01">Ene</option>
                                        <option value="02">Feb</option>
                                        <option value="03">Mar</option>
                                        <option value="04">Abr</option>
                                        <option value="05">May</option>
                                        <option value="06">Jun</option>
                                        <option value="07">Jul</option>
                                        <option value="08">Ago</option>
                                        <option value="09">Sep</option>
                                        <option value="10">Oct</option>
                                        <option value="11">Nov</option>
                                        <option value="12">Dic</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 block mb-1">Hasta</span>
                                <div class="flex gap-1">
                                    <select id="special-year-end" class="w-1/2 p-1 border rounded">
                                        <option value="2023">2023</option>
                                        <option value="2024" selected>2024</option>
                                        <option value="2025">2025</option>
                                    </select>
                                    <select id="special-month-end" class="w-1/2 p-1 border rounded">
                                        <option value="01">Ene</option>
                                        <option value="02">Feb</option>
                                        <option value="03">Mar</option>
                                        <option value="04">Abr</option>
                                        <option value="05">May</option>
                                        <option value="06">Jun</option>
                                        <option value="07">Jul</option>
                                        <option value="08">Ago</option>
                                        <option value="09">Sep</option>
                                        <option value="10">Oct</option>
                                        <option value="11">Nov</option>
                                        <option value="12" selected>Dic</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECCIÓN 2: IDS y DESCARGA -->
            <div class="flex flex-col h-full">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <span
                        class="bg-blue-100 text-blue-700 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                    Listado de IDs
                </h3>

                <div class="flex flex-col flex-1 gap-4">
                    <div class="relative flex-1">
                        <textarea id="special-ids"
                            class="w-full h-full p-4 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none font-mono text-sm"
                            placeholder="Pega aquí los IDs (uno por línea)..."></textarea>

                        <div class="absolute bottom-4 right-4 flex gap-2">
                            <button onclick="document.getElementById('excel-id-upload').click()"
                                class="bg-green-500 text-white px-3 py-1 rounded text-sm shadow hover:bg-green-600 transition">
                                <i class="fa-solid fa-file-excel mr-1"></i> Cargar Excel
                            </button>
                            <input type="file" id="excel-id-upload" hidden accept=".xlsx, .xls, .csv"
                                onchange="handleIdExcelUpload(this)">

                            <button onclick="document.getElementById('special-ids').value=''"
                                class="bg-slate-200 text-slate-600 px-3 py-1 rounded text-sm hover:bg-slate-300 transition">
                                Limpiar
                            </button>
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <h4 class="text-sm font-bold text-blue-800 mb-2">Instrucciones:</h4>
                        <ol class="text-xs text-blue-700 list-decimal list-inside space-y-1">
                            <li>Define los filtros y carga los IDs.</li>
                            <li>Descarga el archivo <b>filtros_extrae.json</b>.</li>
                            <li>Guárdalo en: <code>Documents/Consumos/consultas/entradas/</code></li>
                            <li>Ejecuta: <code>python extractor_personalizado.py</code></li>
                        </ol>
                    </div>

                    <button onclick="generateFiltersJson()"
                        class="primary-btn w-full py-4 rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2">
                        <i class="fa-solid fa-file-export"></i> Generar Archivo JSON
                    </button>

                    <!-- SECCIÓN 3: ENVIAR -->
                    <div id="email-section" class="hidden mt-4 pt-4 border-t border-slate-200 animate-fade-in">
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mb-3">
                            <p class="text-xs text-yellow-800 font-bold mb-1"><i
                                    class="fa-solid fa-triangle-exclamation mr-1"></i> IMPORTANTE:</p>
                            <p class="text-xs text-yellow-700">No olvides <b>adjuntar el archivo descargado</b> en el
                                correo que se abrirá a continuación.</p>
                        </div>
                        <button onclick="sendEmail()"
                            class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition shadow-lg flex items-center justify-center gap-2 mb-3">
                            <i class="fa-solid fa-envelope-open-text"></i> Abrir Correo (Outlook/App)
                        </button>

                        <div class="text-center text-xs text-gray-400 mb-2">- O SI USAS CORREO WEB -</div>

                        <div class="bg-white p-3 rounded border border-gray-200 text-sm">
                            <p class="font-bold text-gray-700 mb-1">Copia y pega esto en tu correo:</p>
                            <div class="grid grid-cols-[60px_1fr] gap-2 text-left">
                                <span class="text-gray-500 text-right">Para:</span>
                                <code id="manual-to" class="bg-gray-100 p-1 rounded select-all cursor-pointer"
                                    onclick="copyText(this)">crisrojagu@colsubsidio.com</code>

                                <span class="text-gray-500 text-right">Asunto:</span>
                                <code id="manual-subject" class="bg-gray-100 p-1 rounded select-all cursor-pointer"
                                    onclick="copyText(this)">SOLICITUD CONSUMOS...</code>

                                <span class="text-gray-500 text-right">Cuerpo:</span>
                                <textarea id="manual-body" rows="4"
                                    class="w-full bg-gray-100 p-1 rounded text-xs select-all resize-none" readonly
                                    onclick="this.select()"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        function generateFiltersJson() {
            const rawIds = document.getElementById('special-ids').value;
            const ids = rawIds.split(/[\n,;\t]+/).map(id => id.trim()).filter(id => id.length > 0);

            const solicitante = document.getElementById('solicitante-name').value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '');

            if (!solicitante) {
                alert("Por favor ingresa el nombre del Solicitante.");
                return;
            }

            if (ids.length === 0) {
                alert("Por favor ingresa al menos un ID o carga un Excel.");
                return;
            }

            const params = {
                metadata: {
                    solicitante: solicitante,
                    created_at: new Date().toISOString()
                },
                ids: ids,
                type: document.querySelector('input[name="extract-type"]:checked').value,
                ues: document.getElementById('special-ues').value,
                date_start: `${document.getElementById('special-year-start').value}-${document.getElementById('special-month-start').value}`,
                date_end: `${document.getElementById('special-year-end').value}-${document.getElementById('special-month-end').value}`
            };

            const date = new Date();
            const timestamp = date.getFullYear() +
                String(date.getMonth() + 1).padStart(2, '0') +
                String(date.getDate()).padStart(2, '0') + "_" +
                String(date.getHours()).padStart(2, '0') +
                String(date.getMinutes()).padStart(2, '0') +
                String(date.getSeconds()).padStart(2, '0');

            // Filename format: solicitud_{TIMESTAMP}_{SOLICITANTE}.json
            const filename = `solicitud_${timestamp}_${solicitante}.json`;
            lastGeneratedFilename = filename;
            lastSolicitante = solicitante;

            const blob = new Blob([JSON.stringify(params, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Prepare Email Content
            const ues = params.ues;
            const dateRange = `${params.date_start} a ${params.date_end}`; // Or just start if simple

            // Format: SOLICITUD CONSUMOS - [UES] - [FECHA] - [SOLICITANTE]
            const subject = `SOLICITUD CONSUMOS - ${ues} - ${dateRange} - ${solicitante}`;
            const body = `Hola,\n\nAdjunto envío el archivo de solicitud generado: ${filename}\n\nDetalles:\n- UES: ${ues}\n- Rango: ${dateRange}\n- Solicitante: ${solicitante}\n\nPor favor procesar.\n\nAtentamente,\n${solicitante}`;

            lastGeneratedSubject = subject;
            lastGeneratedBody = body;

            // Update UI for Manual Copy
            document.getElementById('manual-subject').innerText = subject;
            document.getElementById('manual-body').value = body;

            // Show Email Section
            document.getElementById('email-section').classList.remove('hidden');
        }

        let lastGeneratedFilename = "";
        let lastSolicitante = "";
        let lastGeneratedSubject = "";
        let lastGeneratedBody = "";

        // CONFIGURA TU CORREO AQUÍ
        const ADMIN_EMAIL = "crisrojagu@colsubsidio.com";

        function sendEmail() {
            if (!lastGeneratedSubject) return;
            window.location.href = `mailto:${ADMIN_EMAIL}?subject=${encodeURIComponent(lastGeneratedSubject)}&body=${encodeURIComponent(lastGeneratedBody)}`;
        }

        function copyText(element) {
            const text = element.tagName === 'INPUT' || element.tagName === 'TEXTAREA' ? element.value : element.innerText;
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback check
                const origin = element.style.backgroundColor;
                element.style.backgroundColor = '#dcfce7'; // green-100
                setTimeout(() => element.style.backgroundColor = origin, 200);
            });
        }

        async function handleIdExcelUpload(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                if (jsonData.length < 1) return;

                const headers = jsonData[0].map(h => String(h).toUpperCase().trim());
                let idIndex = headers.findIndex(h => h.includes("ID") || h.includes("NIT") || h.includes("CEDULA") || h.includes("IDENTIFICACION"));
                if (idIndex === -1) idIndex = 0;

                const ids = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row[idIndex]) ids.push(row[idIndex]);
                }

                if (ids.length > 0) {
                    const currentVal = document.getElementById('special-ids').value;
                    const newVal = (currentVal ? currentVal + "\n" : "") + ids.join("\n");
                    document.getElementById('special-ids').value = newVal;
                    alert(`Se cargaron ${ids.length} IDs.`);
                }
            } catch (e) {
                console.error(e);
                alert("Error leyendo Excel.");
            }
            input.value = "";
        }
    </script>
</body>

</html>